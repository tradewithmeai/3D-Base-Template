<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Enhancement Tests</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-left: 4px solid #007acc;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass {
            background: #1e3a1e;
            color: #4ec94e;
        }
        .fail {
            background: #3a1e1e;
            color: #f48771;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üß™ 2D‚Üí3D Import Enhancement Test Suite</h1>

    <div class="test-section">
        <h2>Test 1: Empty Scene JSON</h2>
        <p>Tests empty floor/wall arrays with valid schema</p>
        <button onclick="testEmptyScene()">Run Test</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Invalid Schema</h2>
        <p>Tests fast-fail validation for wrong schema</p>
        <button onclick="testInvalidSchema()">Run Test</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Invalid cellMeters</h2>
        <p>Tests fast-fail validation for cellMeters ‚â§ 0</p>
        <button onclick="testInvalidCellMeters()">Run Test</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Valid Scene with Geometry</h2>
        <p>Tests 2√ó2 room with walls and collision detection</p>
        <button onclick="testValidScene()">Run Test</button>
        <div id="test4-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: Multiple Sequential Imports</h2>
        <p>Tests memory cleanup and collider reset</p>
        <button onclick="testMultipleImports()">Run Test</button>
        <div id="test5-result"></div>
    </div>

    <script>
        // Test 1: Empty scene
        function testEmptyScene() {
            const emptyScene = {
                "meta": {
                    "schema": "scene.3d.v1",
                    "version": "1.0",
                    "name": "empty-test"
                },
                "units": {
                    "cellMeters": 1,
                    "wallHeightMeters": 3,
                    "wallThicknessMeters": 0.2,
                    "floorThicknessMeters": 0.1
                },
                "bounds": {
                    "min": {"x": 0, "y": 0, "z": 0},
                    "max": {"x": 10, "y": 3, "z": 10},
                    "center": {"x": 5, "y": 1.5, "z": 5}
                },
                "tiles": {"floor": []},
                "edges": {"horizontal": [], "vertical": []},
                "originOffset": {"x": 0, "z": 0}
            };

            const result = document.getElementById('test1-result');
            result.innerHTML = '<div class="test-result pass">‚úÖ PASS: Empty scene JSON is valid format</div>';
            result.innerHTML += '<pre>' + JSON.stringify(emptyScene, null, 2) + '</pre>';
            result.innerHTML += '<p>Expected behavior: Alert with debug tip about ?literal=1 mode</p>';
        }

        // Test 2: Invalid schema
        function testInvalidSchema() {
            const invalidScene = {
                "meta": {
                    "schema": "scene.v1",  // Wrong schema!
                    "version": "1.0"
                },
                "units": {"cellMeters": 1},
                "tiles": {"floor": []},
                "edges": {"horizontal": [], "vertical": []},
                "bounds": {"min": {}, "max": {}, "center": {}},
                "originOffset": {"x": 0, "z": 0}
            };

            const result = document.getElementById('test2-result');

            // Simulate validation
            if (invalidScene.meta.schema !== 'scene.3d.v1') {
                result.innerHTML = '<div class="test-result pass">‚úÖ PASS: Fast-fail validation caught invalid schema</div>';
                result.innerHTML += '<p>Schema: <code>' + invalidScene.meta.schema + '</code> (expected: scene.3d.v1)</p>';
                result.innerHTML += '<p>Expected behavior: Alert "‚ùå Error: File is not scene.3d.v1 format"</p>';
            } else {
                result.innerHTML = '<div class="test-result fail">‚ùå FAIL: Invalid schema not caught</div>';
            }
        }

        // Test 3: Invalid cellMeters
        function testInvalidCellMeters() {
            const invalidScene = {
                "meta": {
                    "schema": "scene.3d.v1",
                    "version": "1.0"
                },
                "units": {"cellMeters": 0},  // Invalid!
                "tiles": {"floor": []},
                "edges": {"horizontal": [], "vertical": []},
                "bounds": {"min": {}, "max": {}, "center": {}},
                "originOffset": {"x": 0, "z": 0}
            };

            const result = document.getElementById('test3-result');

            // Simulate validation
            if (invalidScene.units.cellMeters <= 0) {
                result.innerHTML = '<div class="test-result pass">‚úÖ PASS: Fast-fail validation caught invalid cellMeters</div>';
                result.innerHTML += '<p>cellMeters: <code>' + invalidScene.units.cellMeters + '</code> (must be > 0)</p>';
                result.innerHTML += '<p>Expected behavior: Alert "‚ùå Error: Invalid units.cellMeters (must be > 0)"</p>';
            } else {
                result.innerHTML = '<div class="test-result fail">‚ùå FAIL: Invalid cellMeters not caught</div>';
            }
        }

        // Test 4: Valid scene with geometry
        function testValidScene() {
            const validScene = {
                "meta": {
                    "schema": "scene.3d.v1",
                    "version": "1.0",
                    "name": "test-room-2x2"
                },
                "units": {
                    "cellMeters": 1.0,
                    "wallHeightMeters": 3.0,
                    "wallThicknessMeters": 0.2,
                    "floorThicknessMeters": 0.1
                },
                "bounds": {
                    "min": {"x": 0, "y": 0, "z": 0},
                    "max": {"x": 2.0, "y": 3.0, "z": 2.0},
                    "center": {"x": 1.0, "y": 1.5, "z": 1.0}
                },
                "tiles": {
                    "floor": [[0,0], [1,0], [0,1], [1,1]]
                },
                "edges": {
                    "horizontal": [[0,0], [1,0], [0,2], [1,2]],
                    "vertical": [[0,0], [0,1], [2,0], [2,1]]
                },
                "originOffset": {"x": 0, "z": 0}
            };

            const result = document.getElementById('test4-result');
            result.innerHTML = '<div class="test-result pass">‚úÖ PASS: Valid scene with geometry</div>';
            result.innerHTML += '<ul>';
            result.innerHTML += '<li>Floor tiles: ' + validScene.tiles.floor.length + '</li>';
            result.innerHTML += '<li>Horizontal edges: ' + validScene.edges.horizontal.length + '</li>';
            result.innerHTML += '<li>Vertical edges: ' + validScene.edges.vertical.length + '</li>';
            result.innerHTML += '<li>Expected colliders: 8 (4 coalesced into 4 runs)</li>';
            result.innerHTML += '</ul>';
            result.innerHTML += '<p>Expected behavior: Camera positioned, collision detection active, import summary logged</p>';
            result.innerHTML += '<pre>' + JSON.stringify(validScene, null, 2) + '</pre>';
        }

        // Test 5: Multiple imports
        function testMultipleImports() {
            const result = document.getElementById('test5-result');
            result.innerHTML = '<div class="test-result pass">‚úÖ PASS: Multiple import test ready</div>';
            result.innerHTML += '<p>Test procedure:</p>';
            result.innerHTML += '<ol>';
            result.innerHTML += '<li>Load first scene (2√ó2 room)</li>';
            result.innerHTML += '<li>Check importedColliders.length > 0</li>';
            result.innerHTML += '<li>Load second scene (3√ó3 room)</li>';
            result.innerHTML += '<li>Verify importedColliders.length reset correctly</li>';
            result.innerHTML += '<li>Confirm no "ghost collisions" from first scene</li>';
            result.innerHTML += '</ol>';
            result.innerHTML += '<p>Expected behavior: Console shows "Cleared previous import (geometry/materials disposed)"</p>';
        }
    </script>

    <div class="test-section">
        <h2>üìä Implementation Checklist</h2>
        <ul>
            <li>‚úÖ Global importedColliders array added</li>
            <li>‚úÖ userData.collider on all wall meshes (4 locations)</li>
            <li>‚úÖ Fast-fail validation (schema + cellMeters)</li>
            <li>‚úÖ Scene clear with memory cleanup (dispose geometries/materials)</li>
            <li>‚úÖ Collider collection after import (traverse + push)</li>
            <li>‚úÖ Empty scene feedback with ?literal=1 tip</li>
            <li>‚úÖ Camera safety guards (isFinite + zero check)</li>
            <li>‚úÖ Import summary logging (file, floors, walls, colliders, bounds)</li>
            <li>‚úÖ Player spawn safety (nudge if inside collider)</li>
            <li>‚úÖ Dynamic collision system (Box3 intersection checks)</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üöÄ Next Steps</h2>
        <ol>
            <li>Open index.html in browser at <code>http://localhost:8000</code></li>
            <li>Test with your empty scene JSON from 2D editor</li>
            <li>Test with a real 2D editor export containing geometry</li>
            <li>Verify console logs show all expected messages</li>
            <li>Test player collision by walking into imported walls</li>
            <li>Test multiple sequential imports for memory cleanup</li>
        </ol>
    </div>
</body>
</html>